<html>
<head>
<meta charset='utf-8'/>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
<div class="dropdown">
    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Choix
    <span class="caret"></span></button>
    <ul class="dropdown-menu">
      <li onclick="query('2015')">2015</li>
      <li onclick="query('2017')">2017</li>
      <li onclick="query('oall')">Fusion 2015-2017</li>
      <li>Hi√©rarchie des SIG</li>
    </ul>
</div>
<div class="sigma" id="sigma-container-2015"></div>
<div class="sigma" id="sigma-container-2017"></div>
<div class="sigma" id="sigma-container-oall"></div>
<div class="sigma" id="sigma-container-emmm"></div>
<script src="js/sigma.js"></script>
<script src="plugins/sigma.parsers.json.min.js"></script>
<script src="plugins/sigma.neo4j.cypher.min.js"></script>
<script src="plugins/sigma.layout.forceAtlas2.min.js"></script>
<script src="plugins/sigma.layout.noverlap.min.js"></script>
<script src="plugins/sigma.plugins.animate.min.js"></script>

<style type="text/css">

        /* Set height on the div or it will have zero height */
        .sigma {
            width: 49%;
            height: 50%;
        }
        #sigma-container-2015 {
            /*display:block;*/
            float:left;
            border-style: solid;
            display: none;
        }
        #sigma-container-2017 {
            /*display:block;*/
            float:right;
            border-style: solid;
            /*overflow:hidden;*/
            display: none;
        }
        #sigma-container-oall {
            float:left;
            border-style:solid;
            margin-top:20px;
            display: none;
        }
        #sigma-container-emmm {
            /*display:block;*/
            float:right;
            border-style: solid;
            /*overflow:hidden;*/
            display: none;
        }
    </style>
<script>
  var queries = {
      "2015": "MATCH (n:Node2017) OPTIONAL MATCH (n)-[r]->(m) RETURN n,r,m",
      "2017": "MATCH (n:Node2015) OPTIONAL MATCH (n)-[r]->(m) RETURN n,r,m",
      "oall": "MATCH (n:Nodeoall) OPTIONAL MATCH (n)-[r]->(m) RETURN n,r,m",
      "eaniemeanieminymoe" : "MATCH (n)-[r]->(m) RETURN r,n,m",
  };
  var pwd = '87cEbq9d';
  var login = 'neo4j';
  var connect = 'http://0.0.0.0:7474';
  var xKeep = {};
  var yKeep = {};
  var cont = [];
  var ids = {};
  function query(label){
      sigma.neo4j.cypher(
      { url: connect, user: login, password: pwd },
      queries[label],
      { container: 'sigma-container-'+label},
        function(s){
          cont[cont.length] = s;
          graphstart(s);
        });
        document.getElementById('sigma-container-'+label).style.display = 'block';
  }
  function graphstart(s) {
    //Params for Directed graph with visible edges
    s.settings('defaultEdgeType', 'arrow');
    s.settings('minArrowSize', 100);
    //Camera for recentering on node after click
    s.addCamera('cam0');
    var listener = s.configNoverlap({nodeMargin: 1, scaleNodes: 1.05, gridSize: 75, duration: 1});
    var focus;
      // We first need to save the original colors of our
      // nodes and edges, like this:
      s.graph.nodes().forEach(function(n) {
        n.originalColor = n.color;
        n.label = n.neo4j_data['name'];
        s.refresh();
      });
      s.graph.edges().forEach(function(e) {
        e.originalColor = e.color;
      });
      s.startForceAtlas2({
            linLogMode: true,
            outboundAttractionDistribution: !1,
            adjustSizes: false,
            edgeWeightInfluence: 0,
            scalingRatio: 0.5,
            strongGravityMode: !1,
            gravity: 1,
            barnesHutOptimize: false,
            barnesHutTheta: 0.5,
            slowDown: 1,
            startingIterations: 1,
            iterationsPerRender: 1,
            worker: true
        });
      s.startNoverlap();
      s.bind('overNode',function(e) {
        //if a node is hovered, stop Forces from calculating
        s.stopForceAtlas2();
      });
      s.bind('clickNode', function(e) {
        var nodeId = e.data.node.id,
            toKeep = s.graph.neighbors(nodeId);
        toKeep[nodeId] = e.data.node;

        s.graph.nodes().forEach(function(n) {
          ids[n.id] = n;
          if (toKeep[n.id])
            n.color = n.originalColor;
          else{
            n.color = '#eee';
            }
          if (n.id == nodeId){
            focus = n;
            s.cameras[0].goTo({x:focus['read_cam0:x'],y:focus['read_cam0:y'],ratio:0.55});
            cont.forEach(function(si){
              if (si != s){
                si.graph.nodes().forEach(function(nn){
                    if (nn.label == n.label && !ids[nn.id]){
                      ids[nn.id] = nn;
                      var ev = e;
                      ev.data.node = nn;
                      si.dispatchEvent('clickNode',ev.data);
                      // si.cameras[0].goTo({x:nn['read_cam0:x'],y:nn['read_cam0:y'],ratio:0.55});
                    }
                });
              }
            });
          }
        });
        cont.forEach(function(si){
            si.graph.edges().forEach(function(e) {
              if (toKeep[e.source] && toKeep[e.target])
                e.color = e.originalColor;
              else
                e.color = '#eee';
            });
        });

        // Since the data has been modified, we need to
        // call the refresh method to make the colors
        // update effective.
        s.refresh();
        ids = [];
      });
      s.bind('clickStage', function(e) {
        cont.forEach(function(si){
            si.graph.nodes().forEach(function(n) {
              n.color = n.originalColor;
              if (focus != null){
                      si.cameras[0].goTo({x:0,y:0,ratio:1});
                  }

              });
              si.graph.edges().forEach(function(e) {
                e.color = e.originalColor;
              });
    });
      focus = null;
      s.refresh();
      });
    }
  // Add a method to the graph model that returns an
  // object with out neighbors of a node inside:
  sigma.classes.graph.addMethod('neighbors', function(nodeId) {
    var k,
        neighbors = {},
        index = this.outNeighborsIndex[nodeId] || {};

    for (k in index)
      neighbors[k] = this.nodesIndex[k];

    return neighbors;
  });


  //TODO: Automatize this with GetLabels and query every single graph within a new container each time
  // sigma.neo4j.cypher(
  // { url: connect, user: login, password: pwd },
  // 'MATCH (n:Node2015) OPTIONAL MATCH (n)-[r]->(m) RETURN n,r,m',
  // { container: 'sigma-container-2015'},
  //   function(s){
  //     cont[cont.length] = s;
  //     graphstart(s);
  //   });
  // sigma.neo4j.cypher(
  // { url: connect, user: login, password: pwd },
  // 'MATCH (n:Node2017) OPTIONAL MATCH (n)-[r]->(m) RETURN n,r,m',
  // { container: 'sigma-container-2017'},
  //   function(s){
  //     cont[cont.length] = s;
  //     graphstart(s);
  //   });
  //   sigma.neo4j.cypher(
  //   { url: connect, user: login, password: pwd },
  //   'MATCH (n:Nodeoall) OPTIONAL MATCH (n)-[r]->(m) RETURN n,r,m',
  //   { container: 'sigma-container-oall'},
  //     function(s){
  //       cont[cont.length] = s;
  //       graphstart(s);
  //     });
  // Calling neo4j to get all its relationship type
sigma.neo4j.getTypes(
        { url: connect, user:login, password:pwd },
        function(rel) {
            console.log("Relationship types " + rel);
        }
);
// Calling neo4j to get all its node label
sigma.neo4j.getLabels(
        { url: connect, user:login, password:pwd },
        function(labels) {
            console.log("Node labels " + labels);
        }
);
</script>
</body>
</html>
